name: SSM Router

on:
  push:
    branches: [main, develop]
    paths: ['*.yml']
  pull_request:
    branches: [main]
    paths: ['*.yml']
  workflow_dispatch:
    inputs:
      action:
        type: choice
        options: [plan, apply, destroy]
        default: plan
      environment:
        type: choice
        options: [dev, staging, prod]
        default: dev

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    uses: ./.github/workflows/validate.yml

  plan:
    needs: validate
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
    uses: ./.github/workflows/plan.yml
    with:
      environment: ${{ github.event.inputs.environment || 'dev' }}
    secrets: inherit

  apply:
    needs: validate
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
    uses: ./.github/workflows/apply.yml
    with:
      environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'prod' || 'dev') }}
    secrets: inherit

  destroy:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    uses: ./.github/workflows/destroy.yml
    with:
      environment: ${{ github.event.inputs.environment || 'dev' }}
    secrets: inherit